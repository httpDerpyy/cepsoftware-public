<html lang="en">

<head>

    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CEP Software</title>

    <style>
        table {
            border-collapse: separate;
            border-spacing: 0 3px;
        }

        td,
        th {
            border: 1px solid #dddddd;
            text-align: left;
            padding: 8px;
        }

        tr:nth-child(even) {
            background-color: #dddddd;
        }
    </style>


</head>

<body>

    <ul>
        <li><a href='http://187.182.179.245:25565/'>Frete</a></li>
        <li> <a href='http://187.182.179.245:25565/config'>Configuração</a></li>
        <li> <a href='http://187.182.179.245:25565/registro'>Registrar CEP</a></li>
    </ul>

    <h1>Calculadora Frete</h1>

    <form style='display: flex; flex-direction: column; margin-right: 93%;'>

        <label>Motoboy</label>
        <input type='text' id='inputMotoboy'>

        <br><br>
        <label>CEP</label>
        <input type='text' id='inputCEP' onclick='this.value=""'>

        <br><br>
        <label>Identificação</label>
        <input type='text' id='inputIdentificar' onclick='this.value=""'>

        <br>
        <input type='button' value='Pesquisar' id='pesquisar'>

    </form>

    <br><br>
    <b>Endereço:</b>
    <label id='endereco'>Test</label>

    <br><br>
    <b>Distancia:</b>
    <label id='distancia'>Test</label>

    <br><br>
    <b>Preço:</b>
    <label id='preco'>Test</label>

    <br><br>
    <input type='button' value='Confirmar Operação' id='confirmar'>

    <br><br>
    <h2>Financeiro</h2>

    <table id='financeiro' style='margin-bottom: 20px;'>

        <tr>
            <th>Motoboy</th>
            <th>Entregas</th>
            <th>Diaria</th>
            <th>Total</th>
        </tr>

        <tr id='financeiroExample'>
            <td id='financeiroNome'>1000</td>
            <td id='financeiroEntregas'>R$ 5,00</td>
            <td id='financeiroDiaria'>R$ 5,00</td>
            <td id='financeiroValor'>R$ 5,00</td>
        </tr>

    </table>

    <br>
    <h2>Histórico</h2>

    <table id='historico' style='margin-bottom: 20px;'>

        <tr>
            <th>Endereço</th>
            <th>Preço</th>
            <th>Motoboy</th>
            <th>Identificação</th>
            <th>Remover</th>
        </tr>

        <tr id='historicoExample'>
            <td id='enderecoHistorico'>1000</td>
            <td id='precoHistorico'>R$ 5,00</td>
            <td id='motoboyHistorico'>R$ 5,00</td>
            <td id='identificarHistorico'>R$ 5,00</td>
            <td><input type='button' value='Remover' id='removerExemploHistorico'></td>
        </tr>

    </table>

    <script defer>

        // Feedback
        const timer = ms => new Promise(res => setTimeout(res, ms));

        // Preço por Kilometro
        let prices = undefined
        let data_motoboys = undefined

        // Data Financeira
        const dataFinanceira = {}

        fetch('http://187.182.179.245:25565/data')
        .then(response => response.json())
        .then(data => {

            prices = data.Metragens
            data_motoboys = data.Motoboys 

            data_motoboys.forEach(element => {
                let entry = dataFinanceira[element.Nome] || { entregas: 0, valor: Number(element.Diaria) } ; dataFinanceira[element.Nome] = entry ;
                entry.Diaria = Number(element.Diaria)
            });

        })

        // Globals
        let precoFinal = 0

        function EncontrarPreco(dist) {
            for (let i = 1; i < prices.length; i++) {

                let precoAnterior = prices[i - 1]
                let precoAtual = prices[i]

                if (dist >= (precoAnterior.Metragem) && dist <= precoAtual.Metragem) {
                    return precoAnterior.Valor
                }
            }

            if (dist <= prices[0].Metragem) {
                return prices[0].Valor
            }

            return prices[prices.length - 1].Valor
        }

        // Processar Localização
        const pesquisar = document.getElementById('pesquisar')

        const endereco = document.getElementById('endereco')
        const preco = document.getElementById('preco')
        const distancia = document.getElementById('distancia')

        function Pesquisar() {

            let cepAlvo = document.getElementById('inputCEP').value

            // Remover Tracinhos
            cepAlvo = cepAlvo.toString()
            cepAlvo = cepAlvo.replace("-", "")

            console.log(cepAlvo)

            const rota = "http://187.182.179.245:25565/cep?alvo=" + cepAlvo

            fetch(rota)
                .then(response => response.json())
                .then(data => {

                    if (data.status != "OK") {
                        pesquisar.value = "CEP Inválido!"
                        timer(2000).then(_ => pesquisar.value = "Pesquisar")
                        return;
                    } else {
                        pesquisar.value = "Endereço Encontrado!"
                        timer(2000).then(_ => pesquisar.value = "Pesquisar")
                    }

                    endereco.innerHTML = data.address
                    distancia.innerHTML = data.distanceText

                    console.log(data)

                    // Calculando Preço
                    precoFinal = EncontrarPreco(data.distanceValue)
                    preco.innerHTML = "R$ " + precoFinal + ",00"

                })
        }

        pesquisar.addEventListener('click', Pesquisar)

        // Encontrar Exemplos
        const financeiroExample = document.getElementById('financeiroExample')
        const historicoExample = document.getElementById('historicoExample')

        const historico = document.getElementById('historico')
        const financeiro = document.getElementById('financeiro')

        financeiroExample.remove()
        historicoExample.remove()

        // Criar Nova Entry
        function CriarHistorico() {

            // Puxar Informação
            const cep = document.getElementById('inputCEP').value
            const motoboy = document.getElementById('inputMotoboy').value
            let endereco = document.getElementById('endereco').innerHTML
            const preco = document.getElementById('preco').innerHTML
            const identificar = document.getElementById('inputIdentificar').value

            // Parte Financeira
            // Atualização de Raw Data

            let entry = dataFinanceira[motoboy] || { entregas: 0, valor: 0 }; dataFinanceira[motoboy] = entry
            entry.entregas += 1
            entry.valor += Number(precoFinal)

            // Atualização Visual
            // Caso já exista um visual
            let visual = financeiro.querySelector('#' + motoboy)

            if (visual) {

                visual.querySelector('#financeiroValor').innerHTML = "R$ " + entry.valor + ",00"
                visual.querySelector('#financeiroEntregas').innerHTML = entry.entregas

            } else {

                visual = financeiroExample.cloneNode(true)
                financeiro.appendChild(visual)

                visual.id = motoboy

                visual.querySelector('#financeiroNome').innerHTML = motoboy
                visual.querySelector('#financeiroValor').innerHTML = "R$ " + entry.valor + ",00"
                visual.querySelector('#financeiroEntregas').innerHTML = entry.entregas
                visual.querySelector('#financeiroDiaria').innerHTML = "R$ " + entry.Diaria + ",00"

            }

            // Criar entrada no histórico
            const novaEntrada = historicoExample.cloneNode(true)

            novaEntrada.querySelector('#motoboyHistorico').innerText = motoboy
            novaEntrada.querySelector('#enderecoHistorico').innerText = endereco
            novaEntrada.querySelector('#precoHistorico').innerText = preco
            novaEntrada.querySelector('#identificarHistorico').innerText = identificar || "Nenhuma"

            // Remover
            novaEntrada.querySelector('#removerExemploHistorico').addEventListener('click', function () {

                novaEntrada.remove()

                // Update Raw Data
                entry.valor -= precoFinal
                entry.entregas -= 1

                // Update Visual
                visual.querySelector('#financeiroValor').innerHTML = "R$ " + entry.valor + ",00"
                visual.querySelector('#financeiroEntregas').innerHTML = entry.entregas

                if (entry.valor <= 0 || entry.entregas <= 0) {
                    visual.remove()
                }

            })

            historico.appendChild(novaEntrada)

        }

        // Hooks
        const confirmarOperacao = document.getElementById('confirmar')
        confirmarOperacao.addEventListener('click', CriarHistorico)

    </script>

</body>

</html>